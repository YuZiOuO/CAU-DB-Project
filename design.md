# 系统设计文档

## 1. 系统主要功能需求

### 用户管理
- 用户注册与登录：系统支持用户注册新账户和登录现有账户
- 用户权限管理：系统区分普通用户、门店管理员和全局管理员三种角色
- 用户信息管理：用户可以查看和更新个人信息

### 车辆管理
- 车辆类型管理：系统支持管理不同品牌和型号的车辆类型及其日租金
- 车辆信息管理：系统支持添加、查询、更新和删除具体车辆信息
- 车辆状态跟踪：系统跟踪车辆的当前位置（门店）和租赁状态

### 门店管理
- 门店信息管理：系统支持添加、查询、更新和删除门店信息
- 门店库存管理：系统跟踪每个门店的车辆库存

### 租赁管理
- 租赁请求：用户可以发起租赁特定类型车辆的请求
- 租赁审批：门店管理员可以审批租赁请求并分配具体车辆
- 租赁状态跟踪：系统跟踪租赁的状态（待处理、活跃、已归还、已取消）
- 逾期管理：系统自动检测并标记逾期的租赁
- 续租管理：用户可以申请续租，管理员可以审批或拒绝续租请求
- 归还处理：用户或管理员可以标记租赁为已归还

### 车辆转移管理
- 转移请求：管理员可以发起车辆在不同门店之间的转移请求
- 转移审批：源门店管理员可以审批转移请求
- 转移完成：目标门店管理员可以标记转移为已完成
- 自动转移请求：当车辆归还到与租赁门店不同的门店时，系统自动创建转移请求

## 2. 系统模块构成

### 后端模块
- **用户模块**：处理用户认证、授权和信息管理
- **车辆模块**：处理车辆类型和具体车辆的管理
- **门店模块**：处理门店信息管理
- **租赁模块**：处理租赁请求、审批、状态更新和归还
- **车辆转移模块**：处理车辆在不同门店之间的转移
- **数据库模块**：使用 SQLAlchemy ORM 管理与数据库的交互
- **认证模块**：使用 JWT 实现用户认证和授权

### 前端模块
- **用户界面模块**：提供用户登录、注册和个人信息管理界面
- **车辆管理界面模块**：提供车辆查询和管理界面
- **门店管理界面模块**：提供门店查询和管理界面
- **租赁管理界面模块**：提供租赁请求、查询和管理界面
- **车辆转移管理界面模块**：提供车辆转移请求和管理界面
- **管理员仪表板模块**：提供管理员查看系统状态和执行管理操作的界面

## 3. 系统特点或创新点或者难点

### 系统特点
- **多角色权限管理**：系统支持普通用户、门店管理员和全局管理员三种角色，每种角色有不同的权限
- **分布式门店管理**：系统支持多个门店，每个门店有自己的车辆库存和管理员
- **灵活的租赁流程**：系统支持从不同门店租车并归还到不同门店
- **完整的车辆生命周期管理**：从添加到系统、分配到门店、租赁给用户、在门店之间转移，直到最终报废

### 创新点
- **待处理车辆机制**：系统使用特殊的待处理车辆（ID为-1）来处理尚未分配具体车辆的租赁请求
- **自动车辆转移请求**：当车辆归还到与租赁门店不同的门店时，系统自动创建转移请求
- **租赁状态自动检测**：系统自动检测并更新逾期租赁的状态

### 难点
- **并发控制**：确保多个用户同时操作时系统的一致性，特别是在租赁和转移车辆时
- **状态管理**：管理车辆、租赁和转移的多种状态及其转换
- **权限控制**：实现复杂的基于角色的访问控制，确保用户只能执行其权限范围内的操作
- **业务规则实施**：实施复杂的业务规则，如确保车辆在租赁前位于正确的门店，确保没有重复的待处理转移

## 4. 数据流图（最主要功能）

### 租赁流程数据流图

```
+-------------+     租赁请求     +-------------+     审批请求     +-------------+
|             | --------------> |             | --------------> |             |
|    用户     |                 |   系统      |                 |   管理员    |
|             | <-------------- |             | <-------------- |             |
+-------------+     状态更新     +-------------+     分配车辆     +-------------+
      |                               |                              |
      |                               |                              |
      v                               v                              v
+-------------+     归还请求     +-------------+     确认归还     +-------------+
|             | --------------> |             | --------------> |             |
|    用户     |                 |   系统      |                 |   管理员    |
|             | <-------------- |             | <-------------- |             |
+-------------+     状态更新     +-------------+     更新库存     +-------------+
```

### 车辆转移流程数据流图

```
+-------------+     转移请求     +-------------+     审批请求     +-------------+
|             | --------------> |             | --------------> |             |
| 源门店管理员 |                 |   系统      |                 | 源门店管理员 |
|             | <-------------- |             | <-------------- |             |
+-------------+     状态更新     +-------------+     审批确认     +-------------+
                                      |
                                      |
                                      v
+-------------+     完成请求     +-------------+
|             | --------------> |             |
| 目标门店管理员|                 |   系统      |
|             | <-------------- |             |
+-------------+     状态更新     +-------------+
```

## 5. ER图

```
+---------------+       +---------------+       +---------------+
|  VehicleType  |       |    Vehicle    |       |     Store     |
+---------------+       +---------------+       +---------------+
| type_id (PK)  |<----->| vehicle_id(PK)|<----->| store_id (PK) |
| brand         |       | type_id (FK)  |       | store_name    |
| model         |       | store_id (FK) |<----->| address       |
| daily_rent_price|      | manufacture_date|     | phone_number  |
+---------------+       +---------------+       +---------------+
        ^                      ^                      ^
        |                      |                      |
        |                      |                      |
+---------------+       +---------------+       +---------------+
|     Rental    |       |      User     |       |VehicleTransfer|
+---------------+       +---------------+       +---------------+
| rental_id (PK)|       | user_id (PK)  |       |transfer_id(PK)|
| rental_date   |       | name          |       |vehicle_id (FK)|
| rental_store_id(FK)<-->| address       |       |source_store_id(FK)|
| user_id (FK)  |<----->| phone_number  |<----->|destination_store_id(FK)|
| vehicle_id (FK)|<----->| join_date     |       |transfer_date |
| vehicle_type_id(FK)<-->| is_admin      |       |transfer_status|
| expected_return_date|  | managed_store_id(FK)<->|approved_by(FK)|
| return_store_id(FK)|<->| email         |       |completed_date|
| rental_status |       | password_hash  |       |notes         |
| is_overdue    |       +---------------+       +---------------+
+---------------+
```

这个ER图展示了系统中的主要实体及其关系：
- VehicleType 与 Vehicle 是一对多关系（一种车型可以有多个车辆）
- Store 与 Vehicle 是一对多关系（一个门店可以有多个车辆）
- User 与 Rental 是一对多关系（一个用户可以有多个租赁记录）
- Vehicle 与 Rental 是一对多关系（一个车辆可以有多个租赁记录）
- VehicleType 与 Rental 是一对多关系（一种车型可以有多个租赁记录）
- Store 与 Rental 有两个一对多关系（作为租车门店和还车门店）
- Store 与 User 是一对多关系（一个门店可以有多个管理员）
- Vehicle 与 VehicleTransfer 是一对多关系（一个车辆可以有多次转移记录）
- Store 与 VehicleTransfer 有两个一对多关系（作为源门店和目标门店）
- User 与 VehicleTransfer 是一对多关系（多个转移可以由同一个用户批准）